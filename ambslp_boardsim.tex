\label{sec:boardsim}
A small program emulating the board is available within the software
package, this is designed to use as much as possible formats
used by the other programs used to control the board, in example
with respect to pattern bank files or data input. 
The board simulation program is 
\textbf{\texttt{ambslp\_boardsim}}\index{ambslp\_boardsim}. 
The goal of the program 
is compare a given input with the content of a pattern bank, as if loaded
by the real board, and predict list of the output roads. 

The full list of options available is the following:
\begin{description}
	\item[--NChipsPerLAMB num:] this option sets the total number
	of AM chips installed in each of the LAMBs. Default 16.
	
	\item[--NChipsPerChain num:] set the number of chips in the
	readout chain, used to provide the proper assignment of the
	road IDs. Default 4.
	
	\item[--NLAMBs:] sets the number of LAMBs in an AM booard. 
	Default 4.
	
	\item[--NPattsPerChip, -N num:] number of patterns to be
	loaded in each chip. Default 2048.
	
	\item[--BankDCConfig arg:] the argument of this option is a string
	of double-column separated values that describe the number of
	DC bits available in the pattern bank. This value is
	\emph{deprecated} because available in pattern bank file.
	An example il \emph{2:2:2:2:2:2:2:2}, setting 2 DC-bits in 
	each layer.
	
	\item[--verbose, -v:] if present, increases the verbosity of the program.

	\item[--bankType, -T num:] sets the type of the files describing the
	pattern bank. Possible vaules are currently: 0, ROOT format files, 1
	simple ASCII files. ROOT files allow DC-bit representation while
	ASCII files only allow simple pattern, with no DC bits. Default 1.
	
	\item[--nEvents, -e num:] set the maximum number of events to be simulated.
	By default all the events in the input files will be emulated.
	
	\item[--threshold num:] sets the matching threshold for the match.
	Default 7.
	
	\item[--output-file path:] allows to set the path of the file
	where the list of roads expected to match with the given input.
	Default \texttt{outroads\_sim.out}, storing the file in the 
	same directory.
	
	\item[--pattern-file path:] path of the pattern bank files. This
	is also the first positional argument.
	
	\item[--input-file path:] path of one input files. Multiple input
	files are expected, details later. As for the previous, this is
	also a positional option, all arguments after the first are interpreted
	as input files.
\end{description}

The last two options require some additional details, also because the 
command line help automatically generated by the Boost library is not clear.
Those can be used as options or positional arguments of the command line.
The use as positional arguments is more convenient and it will be the only
one reported in the examples that follow:
\begin{verbatim}
$ ambslp_boardsim -T 0 -N 131072 patterns.pbank.root sshits__L{0..11}.ss
\end{verbatim}
the 2 options are used to set the pattern bank file type and how many
patterns should be loaded per chip, in this case available patterns in an 
AM06 chip.
The following positional arguments are the pattern bank file, in the same format
used to load the chips of the board, the following files are
the list of input super-strips, here 12 files, 1 for each input link.
The simulation will save the list of output roads in a file named, by default,
\texttt{outroads\_sim.out}, having the same format of the output 
spy-buffer dump using method 2.

The input files represents the
streams of input data and simulation supports two differe cases:
8 or 12 input streams:
\begin{enumerate}
	\item if 8 input files are passed they are assumed to be 1 per 
	detector layer, where the first input files represents the innermost
	pixel layer used used by the pattern matching and the latest
	the outermost strip layer;
	
	\item if 12 input files are passed this will reflect the fact that
	some layers use 2 links to increase the input bandwidth. The order
	of the files is similar to the previous one but each of the input
	related the innermost 4 layers are distributed in 2 files. Indeed
	file 0 and 1 are related to layer 0, 1 e 2 to layer 1 and so on.
\end{enumerate}
the two way to set the input reflect different debugging scenarios for the use
of the AM board emulation.

\subsubsection{Compare simulation output with spy-buffers}
\label{sec:ambcompare}

An important goal while debugging a board is to compare the output found
in the spy-buffers with the prediction of the board simulation. To
do that a script is available:
 \texttt{\textbf{AMBCompareTestVecOutput.py}}\index{AMBCompareTestVecOutput.py}. 
This python script is available in the PATH of the FTK release and in the
scripts directory of the ambslp package. The script compares the spy-buffer content
with en emulation output allowing to highlight: missing events, matching errors,
highlighting missing, extra or partially matching roads, producing a summary
of the results and optionalyy some histograms.

To use the script it is necessary to have a dump of the output spy buffers
using the so called method 1 or 2, see \ref{sec:spyout} and \ref{sec:spydumper},
and an emulation output, as explained before. The most simple command line
for the script is indeed:
\begin{verbatim}
AMBCompareTestVecOutput.py spybufers.out outroads_sim.out
\end{verbatim}
this compares the content of the spy-buffers, available in the 
\verb|spybuffers.out| file, with the prediction obtained from the simulation for the same events.

By default the scripts output is very detailed and follows this structure:
\begin{itemize}
	\item An header line reporting the ID of ignored LAMBs, more details 
	later on the options.
	
	\item Messages reporting duplicated end-event words found in the spy-buffers
	dump, message like ``EE 0xf7800028 already found, append data''.
	To note that this is normal when the spy-buffer dump is obtained with method
	1, while suggests errors in the board when method 2 is used.
	
	\item Road-by-road comparison. This is the largest block and is created 
	comparing the roads found in a given event with the roads expected by the
	emulation. In this case there are 3 possibilities: perfect match, 
	extra roads,
	missing roads; they will appear as follow:
\begin{verbatim}
  7f6ed908 7f6ed908 (3, 1, 3)
+ fb0610aa          (3, 0, 0)
-          fb0048c3 (0, 0, 0)
\end{verbatim}	
	in case of a perfect match the road word is repeated twice, the value
	between brackets reports the chip ID within the readout chain, the readout
	chain number within the LAMB, the LAMB ID within the board. Extra roads, 
	roads found only by the board, are marked with a \texttt{+} sign at the
	begin of the line, the right column related to the emulation is missing.
	For missing roads, expected by the emulation but not found by the board,
	the line starts with \texttt{-} symbol and the left column is missing.
	Within the block showing the road-by-road comparison there are end-event
	words, used to subdivide the block.
	
	\item After the the report on the roads a block showing eventually missing
	end-events is reported. Here can appear end
\end{itemize}